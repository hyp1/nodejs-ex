<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="https://awri.ch/html/favicon.ico" type="image/vnd.microsoft.icon" />
<meta itemprop="image" content="https://awri.ch/sites/all/themes/awri_jqm/images/home_2.jpg" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" /> 
<title>AWRI - Rechtsfrage Service</title>
<link rel="stylesheet" href="es5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="css/forum.css" />
<link rel="stylesheet" href="css/awrichat.css" />


<script src=" //cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
<!-- <script src="/socket.io/socket.io.js"></script> -->

<script src="es5/bluebird.js"></script>
<script src="es5/jquery-1.11.1.min.js"></script>
<script	src="es5/jquery.mobile-1.4.5.min.js"></script> 
<script src="es5/awriconnecterror-es5.js"></script>
<script src="es5/awriconnect-es5.js"></script>

<script src="es5/awrichat_commands-es5.js"></script>
<script src="es5/awrichatclient-es5.js"></script>
<script src="es5/awrichatutils-es5.js"></script>
<script src="es5/awrichat_theme-es5.js"></script>


<style>  
.inlineIcon  {
    display: inline-block;
    position: relative;
    vertical-align: middle;
}  

</style>

</head>
<body onload="">
  <div data-role="page" id="index">

        <div data-role="panel" id="myheader" data-display="overlay" data-position="right">
                <h3>Mitglieder Online</h3>
                <ul id="users"></ul>
                <br>
                <p style="float:left;"><a href="#" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Schliessen</a></p>
        </div><!-- // Panel -->
            
        <div data-role="header" data-position="fixed">
               <!-- <a href="#" data-icon="back" data-rel="back" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Back</a> -->
                <h1 id="user">AWRI Chat</h1>
            <a class="ui-btn-right" href="#myheader" data-icon="user" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Menu</a>   
        </div> <!--// Header -->
        
        <div data-role="content" class="emojis, loader" style="float:left;">
            <ul id="messages"></ul> 

            <!-- dialog -->
            <div id="dialog" class="hidden">
                <div class="message">Anmeldung</div>
                <input type="text" value="">
                <div>
                  <button class="ok">Weiter</button>
                  <button class="cancel">Zurück</button>
                  </div>
                </div><!--// Dialog -->


           <!-- createdialog -->
           <div id="createdialog" class="hidden" style="width:100%;">
               <div class="node">
                <h1>Rechtsfrage stellen</h1>
                <label for="checkbox-anon" id="createdialog-anon" title="Frage anonym stellen?">Frage anonym stellen? </label>
                <input type="checkbox" name="checkbox" id="checkbox-anon" class="custom" data-mini="true" />                              
                <div id="namePopup">
                    <label for="createdialog-fbname" title="Benutzername">Benutzername</label>   
                    <input type="text" id="createdialog-fbname" disabled/>                  
            </div>
          
            <div class="createdialog-message">Frage:</div>            
            <textarea type="text" id="create" value=""></textarea>
 
   
                        <label for="kanton">Kanton:</label>
                        <select name="kanton" id="kanton"></select>
   
            <a href="#" onclick="toggleUpload(1)">Datei 1</a>
            <div id="upload1" class="hidden">
            <input type="file" id="upload-file1" onchange="_previewFile(this,'upload-preview1',1)">
            <input type="hidden" id="upload-file1-fid" value="-1">         
            <img src="img/preview.jpg" id="upload-preview1" height="200" alt="Image preview...">
            <input type="button" id="remove-file1" onclick="_removeFile(1);" value="Entfernen">
            </div>
            <a href="#" onclick="toggleUpload(2)">Datei 2</a>
            <div id="upload2" class="hidden">
            <input type="file" id="upload-file2" onchange="_previewFile(this,'upload-preview2',2)">
            <input type="hidden" id="upload-file2-fid" value="-1">         
            <img src="img/preview.jpg" id="upload-preview2" height="200" alt="Image preview...">
            <input type="button" id="remove-file2" onclick="_removeFile(2);" value="Entfernen">
        </div>
        <a href="#" onclick="toggleUpload(3)">Datei 3</a>
        <div id="upload3" class="hidden">
            <input type="file" id="upload-file3" onchange="_previewFile(this,'upload-preview3',3)">
            <input type="hidden" id="upload-file3-fid" value="-1">         
            <img src="img/preview.jpg" id="upload-preview3" height="200" alt="Image preview...">
            <input type="button" id="remove-file3" onclick="_removeFile(3);" value="Entfernen">
        </div>
        <a href="#" onclick="toggleUpload(4)">Datei 4</a>
        <div id="upload4" class="hidden">
            <input type="file" id="upload-file4" onchange="_previewFile(this,'upload-preview4',4)">
            <input type="hidden" id="upload-file4-fid" value="-1">         
            <img src="img/preview.jpg" id="upload-preview4" height="200" alt="Image preview...">
            <input type="button" id="remove-file4" onclick="_removeFile(4);" value="Entfernen">
        </div>
        <a href="#" onclick="toggleUpload(5)">Datei 5</a>
        <div id="upload5" class="hidden">
            <input type="file" id="upload-file5" onchange="_previewFile(this,'upload-preview5',5)">
            <input type="hidden" id="upload-file5-fid" value="-1">         
            <img src="img/preview.jpg" id="upload-preview5" height="200" alt="Image preview...">
            <input type="button" id="remove-file5" onclick="_removeFile(5);" value="Entfernen">
       </div>
  
            <div>
              <button class="ok">Frage stellen</button>
              <button class="cancel">Abbrechen</button>
              </div>
            </div>
            </div><!--// Dialog -->

                <!-- upload dialog -->
            <div id="upldialog" class="hidden">
                <div class="message">Hochladen</div>
                <input type="file" id="upload-file" onchange="awri._previewFile(this,'img#upload-preview')">
                <img src="img/preview.jpg" id="upload-preview" height="200" alt="Image preview...">
                <div>
                  <button class="uplok">Weiter</button>
                  <button class="uplcancel">Zurück</button>
                </div>
                </div><!--// Dialog -->
                
        </div> <!--// Content -->      

        <div data-role="footer" data-position="fixed">
      
                <input class="emojis" type="text" id="msg" autocomplete="off" value="">
        <fieldset class="ui-grid-a">
                <div class="ui-block-a">
                        <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
                                <a title="Schnellzugriff auf Chat Befehle" href="#popupCommands" data-rel="popup" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a " data-theme="a">⚡</a>
                                <div data-role="popup" id="popupCommands" data-theme="a">
                                    <ul datarole="listview" id="commandlist" style="padding:0px; margin:0;cursor:pointer;">
                                    <li onclick="cmdNews();">News</li>
                                    <li onclick="cmdCreate();">Rechtsfrage stellen...</li>
                                    <li onclick="cmdSearch('');$('#popupCommands').popup('close');scrollBottom();">Suche Beitrag...</li>                                
                                    <li onclick="$('#msg').val('/show [Beitrag ID]');$('#popupCommands').popup('close');">Zeige Beitrag</li>
                                    <li  name="content" onclick="showClientsPopup(this);">Sende Beitrag an...<ul name="show content [Beitrag ID] " id="clients-content"></ul></li>
                                    <li onclick="$('#msg').val('/show image [Datei ID]');$('#popupCommands').popup('close');">Zeige Bild</li>
                                    <li name="image" onclick="showClientsPopup(this);">Sende Bild an...<ul name="show image [Beitrag ID] " id="clients-image"></ul></li>
                                    <li onclick="$('#msg').val('/adminmsg [Text]');$('#popupCommands').popup('close');">Admin melden</li>
                                    
                                    <li onclick="cmdWhoami();">Wer bin ich?</li>
                                    <li onclick="cmdInfo();">Info</li>
                                    <li onclick="cmdHelp();">Hilfe</li>
                                    <li onclick="cmdBeep();">Alarmton</li>
                                    <li onclick="cmdClear();">Chatfenster leeren</li>
                                    <li style="color:blue;" data-role="list-devider">Mitglieder</li>    
                                    <li onclick="cmdUploads();">Meine Dateien</li>
                                    <li onclick="cmdUpload();">Datei hochladen</li>
                                    <li onclick="$('#msg').val('/bookmarks 0');$('#popupCommands').popup('close');">Lesezeichen</li>
                                    <li onclick="$('#msg').val('/add bookmark [Beitrag ID]');$('#popupCommands').popup('close');">Lesezeichen hinzuf.</li>
                                    <li onclick="$('#msg').val('/del bookmark [Beitrag ID]');$('#popupCommands').popup('close');">Lesezeichen entf.</li>
                                    <li onclick="$('#msg').val('/login [Benutzername] [Passwort]');$('#popupCommands').popup('close');">Anmelden(AWRI)</li>
                                    <li onclick="$('#msg').val('/logout');$('#popupCommands').popup('close');">Abmelden(AWRI)</li>
                                    <li style="color:red;" data-role="list-devider">Admins/Moderatoren</li>   
                                    <li name="whois" onclick="showClientsPopup(this);">Wer ist...<ul name="whois " id="clients-whois"></ul></li>                            
                                    <li onclick="cmdKicks();">Kickliste</li>    
                                    <li name="kick" onclick="showClientsPopup(this);">Kicke...<ul name="kick " id="clients-kick"></ul></li>
                                    <li onclick="cmdBans();">Bannliste</li>    
                                    <li name="ban" onclick="showClientsPopup(this);">Kicke...<ul name="kick " id="clients-ban"></ul></li>                                
                                </ul>
                                </div>

                                <a href="#popupColors" title="Schriftfarbe auswählen" id="actualcolor" data-rel="popup" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini" data-theme="a">🖊️</a>
                                <div data-role="popup" id="popupColors" data-theme="a">
                                    <ul datarole=listview style="padding:0px; margin:0;cursor:pointer;">
                                    <li class="color" style="width:35px;padding:0;height:35px;background-color:#333;" onclick=setColor(this);>&nbsp;</li>          
                                    <li class="color" style=" background-color:#630904;" onclick="setColor(this);">&nbsp;</li>
                                    <li class="color" style="background-color:#170463;" onclick=setColor(this);>&nbsp;</li>          
                                    <li class="color" style="background-color:#635704;" onclick="setColor(this);">&nbsp;</li>
                                    <li class="color" style="background-color:#046318;" onclick="setColor(this);">&nbsp;</li>        
                                    </ul>
                                </div>
                                <a href="#popupTheme" title="Theme auswählen" id="actualcolor" data-rel="popup" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini" data-theme="a">🖥️</a>
                                <div data-role="popup" id="popupTheme" data-theme="a">
                                    <ul datarole=listview style="padding:0px; margin:0;cursor:pointer;">
                                    <li class="color" style="width:35px;height:35px;padding:5 0 5 0;background-color:#f9f9f9;" onclick="$.mobile.changeGlobalTheme('a');"></li>          
                                    <li class="color" style="background-color:#4d4d4d;" onclick="$.mobile.changeGlobalTheme('b');">&nbsp;</li>
                                    <li class="color" style="background-color:#630904;" onclick="$.mobile.changeGlobalTheme('c');">&nbsp;</li>          
                                    <li class="color" style="background-color:#046318;" onclick="$.mobile.changeGlobalTheme('d');">&nbsp;</li>
                                    <li class="color" style="background-color:#000;" onclick="$.mobile.changeGlobalTheme('e');">&nbsp;</li>        
                                    </ul>
                                </div>
                                <a href="#popupEmojis" title="Emojis einfügen" data-rel="popup" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini ui-data-theme-a" data-theme="a">😊</a>
                                <div data-role="popup" id="popupEmojis" data-theme="a">
                                    <ul datarole=listview style="padding:0px; margin:0;cursor:pointer;">
                                    <li class="emojis" style="width:35px;" onclick="putSmiley(this);">😊</li>
                                    <li class="emojis" onclick="putSmiley(this);">😘</li>
                                    <li class="emojis" onclick="putSmiley(this);">😉</li>
                                    <li class="emojis" onclick="putSmiley(this);">😀</li>
                                    <li class="emojis" onclick="putSmiley(this);">😂</li>                                    
                                    <li class="emojis" onclick="putSmiley(this);">😯</li>
                                    <li class="emojis" onclick="putSmiley(this);">😭</li>
                                    <li class="emojis" onclick="putSmiley(this);">😡</li>                    
                                    <li class="emojis" onclick="putSmiley(this);">❤️</li>                                         
                                    <li class="emojis" onclick="putSmiley(this);">👌</li>
                                    <li class="emojis" onclick="putSmiley(this);">🤦</li>
                                    <li class="emojis" onclick="putSmiley(this);">🙏</li>
                                    </ul>
                                </div>
                        </fieldset>         
                    </div>
            <div class="ui-block-b" class="ui-btn-right">
                    <div data-role="controlgroup" data-type="horizontal">
                        <label for="checkbox-mini-0" title="Browser Benachrichtigungen  für private Nachrichtigungen an oder aus schalten">☑️ </label>
                        <input type="checkbox" name="checkbox" id="checkbox-mini-0" class="custom" data-mini="true" />                  
                        <label for="pause" title="Chatnachrichten anhalten">⏸️</label>
                        <input name="pause" type='checkbox' id="pause" href="#" class="custom" data-mini="true"/>                        
                        <a title="Rechtsfrage stellen" href="#" onclick="cmdCreate();" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini" data-theme="a">❓</a>
                        <a title="Zeitline der Beiträge (extern)" href="https://awri.ch/html/timedown.html" target="_BLANK"  data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini" data-theme="a">📅</a>
                        <a title="Chat neu Laden" href="#" onclick="document.location.reload();" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini" data-theme="a">🔃</a>
                        <a title="Chat leeren" href="#" onclick="$('#messages').html('');" data-transition="slideup" class="emojis ui-btn ui-corner-all ui-data-mini" data-theme="a">❌</a>
                        
                        
                        <input title="Nachricht senden [Enter]" type='button' href="#" onclick="sendText();"  value="Senden"> 
                        </div>
            </div>
                 
        </fieldset>
       
         </div>  <!--// Footer -->
    </div><!--// Page -->
    <div class="hidden" data-role="fieldcontain"> 
            <input type="text" id="uid" value="" disabled>   
            <input type="text" id="name" value="" disabled>
            <input type="text" id="private-name" disabled>
            <input type="text" id="private" disabled>
            <input type="hidden" id="token" value="token" disabled>          
    </div>
    
<script>
function scrollBottom(){
    window.scrollTo(0,document.querySelector("#index").scrollHeight);
}

$( document ).on( "pageinit", "#index", function( event ) {

$( "#myheader" ).on( "panelopen", function( event, ui ) {
  //console.log("i am open");
  $('body').css("overflow", "hidden");
} );

$( "#myheader" ).on( "panelclose", function( event, ui ) {
  //console.log("i am close");
  scrollBottom();
  $('body').css("overflow", "auto");
  $('#msg').focus();
} );

//MOTD
awri.awriconnect_load_node(18329).then(function(node){    
appendLine(node.body['und'][0].value);
})

});

//Buttons und Keybindings
$(function() {
    $('#msg').focus();
    $("input#checkbox-mini-0:first").attr("checked",notifications);
    $("#msg").keydown(function (e) {
    //Arrow Keys Up/Down
        if ((e.which && e.which == 38) || (e.keyCode && e.keyCode == 38)) {              
            if(cmdBuffer.length>0){
            cmdBufferIndex=(cmdBufferIndex+1)%cmdBuffer.length;
            $("#msg").val("/"+cmdBuffer[cmdBufferIndex]);
        } 
        }
        if ((e.which && e.which == 40) || (e.keyCode && e.keyCode == 40)) {                   
            if(cmdBufferIndex>0)cmdBufferIndex=(cmdBufferIndex-1);
            else cmdBufferIndex=cmdBuffer.length-1;
            $("#msg").val("/"+cmdBuffer[cmdBufferIndex]);                                
        }
    });

    $("#msg").keypress(function (e) {
    //Enter
        if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
            if($('#msg').val().startsWith('/'))parseCommand($('#msg').val().substr(1,$('#msg').val().length));
            else sendText();
        return false;
        } else {
        return true;
        }
    }); //keypress


$("input[type='checkbox']#checkbox-mini-0").bind( "change", function(event, ui) {
notifications= $('input[type="checkbox"]#checkbox-mini-0').prop("checked");
});

$("input[type='checkbox']#pause").bind( "change", function(event, ui) {
pause= $('input[type="checkbox"]#pause').prop("checked");
});


}); //jQuery



var notifications=false; //browser notifications
var private=false;      //private msg toggle
var pause=false;      //pause msg toggle
var color ='#333';
var audiofile='es5/notification.mp3'; //notification Alarm
var chat=null;
var clients=[];
//Hack für Openshift


//var host = 'http://localhost/stage.awri.ch';
var host = 'https://stage.awri.ch';
var endpoint = 'connect';
awri=new AWRI(host,endpoint);
//AWRI.setLogger(console.log);


var chatsrv = 'nodejs-mongo-persistent-awri-chat.1d35.starter-us-east-1.openshiftapps.com';
cuser= new ChatUser();


(function (){
  //  appendLine('<h2><img style="vertival-align:middle;" src="img/logo_blank_50x50.png"> Willkommen im AWRI Chat<h2>');
  //  appendLine('Schreiben Sie <strong>/info</strong> in den Chat, um weitere Informationen zu erhalten.');
if(location.hostname==='localhost')chat=new ChatClient();
else chat=new ChatClient('https:',chatsrv);

})();

function showUserMenu(elem,id,cmd){
   elem=$('#'+elem);
   elem.show();
   elem.html("");
    clients.forEach(function(client) {
      //  console.log(client);
        var n='<li onclick="'+cmd+'('+id+','+client._uid+');closeUserMenu(\'usermenu-'+id+'\');">'+theme_user_picture(client._picture)+client._name+'</li>';
    $(elem).append(n);
    });
}
function closeUserMenu(elem){
   elem=$('#'+elem);
   elem.hide();
}

function showClientsPopup(el){
var ulc=$("#clients-"+$(el).attr("name"));    
var cmdname=ulc.attr("name");
ulc.empty();

clients.forEach(function(client){
li=document.createElement("li");
$(li).text(client._name);
li.setAttribute("id",client._uid);
$(li).prop("cmd",cmdname);
ulc.append(li).trigger('create');

//document.getElementById("clients").removeEventListener("click",showClientsPopup, true);
});

document.getElementById($(ulc).attr("id")).addEventListener("click",function(e) {
       // e.target is our targetted element.
                    // try doing console.log(e.target.nodeName), it will result LI
        if(e.target && e.target.nodeName == "LI") {
            $("#msg").val("/"+$(e.target).prop('cmd') + e.target.id);
            $("#popupCommands").popup("close"); 
            $(ulc).empty();     
        }
    },false);    
    
};


function showSearchDialog(message) {
    var dialog       = document.getElementById('dialog');
    var input        = dialog.querySelector('input');
    var okButton     = dialog.querySelector('button.ok');
  input.value="";
  input.focus();     
    dialog.querySelector('.message').innerHTML = String(message);
    dialog.className = '';
  
    return new Promise(function(resolve, reject) {
      dialog.addEventListener('click', function handleButtonClicks(e) {
         
//          if(input.value.length<5){
//            dialog.querySelector('.message').innerHTML = "min. 5 Zeichen.";
//            return;
//            }
        if (e.target.tagName !== 'BUTTON') { return; }
        dialog.removeEventListener('click', handleButtonClicks);
        dialog.className = 'hidden';
        if (e.target === okButton) {
        cmdSearch(input.value);
            resolve(input.value);
        } else {
         //document.location.reload();
        }
      })
  })
  }
  function toggleUpload(nr){
      var upload=document.getElementById("upload"+nr);
      $(upload).toggle();
  }

function showCreateDialog(message) {
    var dialog       = document.getElementById('createdialog');
    var input        = dialog.querySelector('textarea');

    var file1        = document.getElementById('upload-preview1');
    var fid1        = document.getElementById('upload-file1-fid');
    var file2        = document.getElementById('upload-preview2');
    var fid2       = document.getElementById('upload-file2-fid');
    var file3        = document.getElementById('upload-preview3');
    var fid3        = document.getElementById('upload-file3-fid');
    var file4        = document.getElementById('upload-preview4');
    var fid4        = document.getElementById('upload-file4-fid');
    var file5        = document.getElementById('upload-preview5');
    var fid5        = document.getElementById('upload-file5-fid');

  var file2        = document.getElementById('upload-preview2');

    var okButton     = dialog.querySelector('button.ok');
    
    dialog.querySelector('.createdialog-message').innerHTML = String(message);
    dialog.className = '';
 $('#createdialog-fbname').val(variable_get("user")._name);
  var kanton=$('#kanton');

awri.awriconnect_taxonomy_term(0,'vid,tid,name,description','parameters[vid]=3',27,'options[orderby][name]=asc').then(function(res){
    for(i=0;i<res.length;i++)kanton.append('<option id="'+res[i].tid+'">'+res[i].name+'</option>')
})

    return new Promise(function(resolve, reject) {
      dialog.addEventListener('click', function handleButtonClicks(e) {
         // alert(e.target.tagName);
        if (e.target.tagName == 'LABEL') {
            if(e.target.id=="createdialog-anon"){
                $("#namePopup").toggle();
            }
        }
        if (e.target.tagName !== 'BUTTON') { return; }
       
        if(e.target==okButton&&input.value.length<10){
         //alert(e.target.className);
         alert("Der Text ist zu kurz");
         $('#create').focus();   
         return;
        }
        dialog.removeEventListener('click', handleButtonClicks);
        dialog.className = 'hidden';
        if (e.target === okButton) {
            var images=[];
            if(fid1.value!=="-1")images.push({fid:fid1.value});
            if(fid2.value!=="-1")images.push({fid:fid2.value});
            if(fid3.value!=="-1")images.push({fid:fid3.value});
            if(fid4.value!=="-1")images.push({fid:fid4.value});
            if(fid5.value!=="-1")images.push({fid:fid5.value});

var n = $("#checkbox-anon");

/*
        if(file1.src.indexOf('img/preview.jpg')==-1){
            awri.awriconnect_upload_file('upload-preview1').then(function(data){
            var result=JSON.parse(data);
            fid1.value=result.fid;
            console.log(result,"UPLOADED1");
            alert("uploaded File1"+result.fid);                
        });
        }
        if(file2.src.indexOf('img/preview.jpg')==-1){
            awri.awriconnect_upload_file('upload-preview2').then(function(data){
            var result=JSON.parse(data);
            fid2.value=result.fid;
        });        
    }
        if(file3.src.indexOf('img/preview.jpg')==-1){
            awri.awriconnect_upload_file('upload-preview3').then(function(data){
            var result=JSON.parse(data);
            fid3.value=result.fid;
        });
}
*/

//alert($("#kanton option:selected").attr('id'));


//"field_image":{"und":[{"fid":"734","uid":"3","filename":"ball_100.png","uri":"public://attachments/ball_100_19.png","filemime":"image/png","filesize":"6967","status":"1","timestamp":"1535724671","type":"image","field_file_image_alt_text":[]
var frage={
    "body": input.value,
    "anonym":+n.prop('checked') ? 1 : 0,
    "fbid": "100000611529195",
    "field_kanton":$("#kanton option:selected").attr('id'),
    "field_image": {"und": images },                         
	
    };
console.log(frage);
       var str='{"body": "Hallo Neu","anonym": "1","fbid": "100000611529195","fbname": "Robert Schweng"}';
        
       
awri.awriconnect_frage_create(JSON.stringify(frage)).then(function(res){
  appendLine("<h1>Ihre Frage wurde gestellt</h1>",'green')
    console.log(res,"CREATE");
}).catch(function(err){
    console.log(err);
});


        
//        if(file2.src.indexOf('img/preview.jpg')!=-1)alert("Kein File2");
//        if(file3.src.indexOf('img/preview.jpg')!=-1)alert("Kein File3");

//        console.log(file1.src);
/*

awri.awriconnect_upload_file('upload-preview2').then(function(data){
    document.getElementById('upload-file2-fid').value=data.fid;
console.log(data,"UPLOADED2");
});
*/
            resolve(input.value);
        } else {
         //document.location.reload();
       return;
        }
      })
  })
  }

function _removeFile(nr){
var file        = document.getElementById('upload-file'+nr);
var preview = document.querySelector("img#upload-preview"+nr); //selects the query named img
var fid        = document.getElementById('upload-file'+nr+'-fid');
fid.value="-1";
file.value="";
preview.src="img/preview.jpg";
}

function _previewFile(filefield,preview,nr){
        var preview = document.querySelector("img#"+preview); //selects the query named img
        var file    = filefield.files[0]; //sames as here
        var reader  = new FileReader();
        var fid        = document.getElementById('upload-file'+nr+'-fid');

        preview.setAttribute('name',filefield.value);
        reader.onloadend = function () {
            preview.src = reader.result;    
            awri.awriconnect_upload_file(preview.id).then(function(file){
fid.value=JSON.parse(file).fid;
            });        
        }     
        if (file) {
            reader.readAsDataURL(file); //reads the data as a URL
        
        } else {
            preview.src = "";
        }            
    }//func

function showDialog(message) {
    var dialog       = document.getElementById('dialog');
    var input        = dialog.querySelector('input');
    var okButton     = dialog.querySelector('button.ok');
  
    dialog.querySelector('.message').innerHTML = String(message);
    dialog.className = '';
  
    return new Promise(function(resolve, reject) {
      dialog.addEventListener('click', function handleButtonClicks(e) {
          if(input.value.length<4){
            dialog.querySelector('.message').innerHTML = "min. 5 Zeichen.";
            return;
            }
        if (e.target.tagName !== 'BUTTON') { return; }
        dialog.removeEventListener('click', handleButtonClicks);
        dialog.className = 'hidden';
        if (e.target === okButton) {
          resolve(input.value);
        } else {
         document.location.reload();
        }
      })
  })
  }

function showUploadDialog(message) {
    var dialog       = document.getElementById('upldialog');
    var file        = dialog.querySelector('file#upload-file');
    var okButton     = dialog.querySelector('button.uplok');
    var img        = dialog.querySelector('img#upload-preview');
  
    dialog.querySelector('.message').innerHTML = String(message);
    dialog.className = '';
  
    return new Promise(function(resolve, reject) {
      dialog.addEventListener('click', function handleButtonClicks(e) {
        if (e.target.tagName !== 'BUTTON') { return; }
        dialog.removeEventListener('click', handleButtonClicks);
        dialog.className = 'hidden';
        if (e.target === okButton) {
          resolve(img);
        } else {
          reject(new Error('User cancelled'));
        }
      })
      scrollBottom();
  })
 
  }


awri.token().then(function(){
if(location.hostname==='localhost')chat=new ChatClient();
else chat=new ChatClient('https:',chatsrv);

    awri.connect().then(function(user){
    cuser= new ChatUser();
    cuser._uid=user.uid;
    cuser._created=Date.now();
    cuser._access=Date.now();
    if(user.uid==0){
  return chat.connect(cuser);
    }else awri.awriconnect_load_user(user.uid).then(function(full){          
            cuser=new ChatUser(full.uid,full.name);
            cuser._roles=full.roles;
            cuser._email=full.mail;
            cuser._fbid=full.field_fbid['und'][0].value;
            if(cuser._fbid!=='undefined')cuser._picture='https://graph.facebook.com/'+cuser._fbid+'/picture?type=small';
            if(full.picture&&full.picture.url!=='undefined')cuser._picture=full.picture.url;

            cuser._created=full.created;
            cuser._access=full.access;
            cuser._token=awri._token;
            cuser._session=awri._session;

            return chat.connect(cuser);
        });
    });
});

function awriconnect_user_connected(user){
//console.log(user,"awriconnect_user_connected");
}

function onchatconnected(user){
//    console.log(user,'chatconnected');
    variable_set('user',user);
    document.title=user._name;
    $('#uid').val(user._uid);
    $('#name').val(user._name);
    $('#user').html(theme_user_picture(user._picture)+' '+user._name);
    $('#user').attr('uid',user._uid);
   // appendLine(user._name+': verbunden mit AWRI Chat','green');
}

function onchatmessage(msg){
    console.log(msg,'onchatmessage');
    if(notifications&&msg._to.uid==variable_get('user')._uid)notify(getFormattedDate(msg._time)+': '+msg._from.name+': '+msg._txt,msg._from.picture,audiofile);
    if(!pause)appendLine('<small>'+getFormattedDate(msg._time)+'</small>: <img src="'+msg._from.picture+'" width="20" height="20"/> '+msg._from.name+': '+msg._txt,msg._color);
}

function onchatuserlist(data){
    clients=data;
    ul = document.getElementById('users');
        ul.innerHTML = "";
        data.forEach(function(user) {
        li = document.createElement('li');
        li.setAttribute('onclick', 'setPriv(this);');
        li.setAttribute('id', user._uid);
        li.setAttribute('title', "["+user._uid+"] "+user._name);
        if($('#private').val()==user._uid)li.classList.add("selected");

    //    if(user_roles_has(user.roles,'moderator'))user.name='<span class="adminsym">🛡️</span>'+user.name;       
    //    if(user_roles_has(user.roles,'administrator'))user.name='<span class="adminsym">⚔️</span>'+user.name;
        
       li.setAttribute('name', user._name);
        //li.appendChild(document.createTextNode(user.uid + ' ' + user.name))
        li.innerHTML=theme_user_picture(user._picture)+' ' + user._name;
        ul.appendChild(li);
        });
}

function onchatcommand(cmd){
console.log(cmd,'onchatcommand');
if(cmd._cmd=='whois data')appendLine(theme_user(cmd._data));

if(cmd._cmd=='kicks data')appendLine(theme_kicks(cmd._data._txt));
if(cmd._cmd=='bans data')appendLine(theme_bans(cmd._data._txt));
if(cmd._cmd=="private command" && cmd._data._txt.startsWith('show content'))showContentFrom(cmd._data._from,cmd._data._txt.substr(12,cmd._data._txt.length));
}



function showContentFrom(from,nid){
    appendLine(from.name +" sendet folgenden Beitrag:","red");
    cmdShow(nid);
};




var private=false;
function setPriv(li){
    if($('#users .selected').attr('id')==li.id)return unsetPriv();
    var name=$('#users .selected').attr('name');

    $('#private').val(li.id);
    $('#private-name').val($(li).attr('name'));
    //alert(li.privatename);
    $('#users  li').removeClass('selected');
    //$('li[id='+li.id+']').addClass('selected');
    $(li).addClass('selected');
    $('#msg').focus();  
    private=true;
};

function unsetPriv(){
    $('#private').val(-1);
    $('#private-name').val('');
    $('#users li').removeClass('selected');
    $('#msg').focus();  
    private=false;
};


function sendText(){
if($('#msg').val()=="")return;
var txt=$('#msg').val();
txt=convertLinks(txt);
if(txt.length==2&&isEmoji(txt))txt='<span style="font-size:2em;">'+txt+'</span>';


var msg=new ChatMessage();
msg.setColor(color);
msg.setFrom($('#uid').val());
msg.setText(txt);
if(private){
    msg.setColor('red');
    chat.sendPrivateMessage($('#private').val(),msg);
    appendLine('<small>'+getFormattedDate(msg._time)+'</small>: <img src="'+variable_get('user')._picture+'" width="20" height="20"> Du an '+$('#private-name').val()+': '+msg._txt,msg._color)
}
else chat.sendMessage(msg);

$('#msg').val("");
$('#msg').focus();
}

function sendPrivateText(to,txt){
msg=new ChatMessage();
//msg.setTo(document.getElementById('To'.value);
msg.setText(document.getElementById('sendPrivateMessage').value);
chat.sendPrivateMessage(document.getElementById('To').value,msg);
document.getElementById('sendPrivateMessage').value="";
document.getElementById('sendPrivateMessage').focus();
}


function setColor(c){
    var actualcol=$('#actualcolor');
    actualcol.attr('style','background-color:'+c.style['background-color']+';color:white;');
    color=c.style['background-color'];
    $('#popupColors').popup("close");
}


function appendLine(text,color){
    if(!color||color=="undefined")color="#333";
    if(!text||text=="undefined")text="";

    ul = document.getElementById('messages');
    li = document.createElement('li');
    li.style.color=color;
    li.innerHTML=text;
    ul.appendChild(li); 
    scrollBottom();   
}

function appendMessage(msg){
    ul = document.getElementById('messages');
    li = document.createElement('li');
    li.style.color=msg._color;
    li.innerHTML=msg._txt;
    ul.appendChild(li); 
    scrollBottom();
}

function putSmiley(c){
    var smiley=($(c).text())
    var txt=$('#msg').val();
    $('#msg').val(txt+smiley);
    $('#popupEmojis').popup("close");
}


function toggleComments(nid) {
    var x = document.getElementById("comments-"+nid);
    if (x.style.display === "none") {
        x.style.display = "block";
        $('#icon-'+nid).removeClass('ui-icon-plus');
        $('#icon-'+nid).addClass('ui-icon-minus');
    } else {
        x.style.display = "none";
        $('#icon-'+nid).removeClass('ui-icon-minus');
        $('#icon-'+nid).addClass('ui-icon-plus');
 
    }
}
    


   /******************************************************/
  /*   Notifications                                     */
 /******************************************************/ 

window.addEventListener('load', function () {
  // At first, let's check if we have permission for notification
  // If not, let's ask for it
  if (window.Notification && Notification.permission !== "granted") {
    Notification.requestPermission(function (status) {
      if (Notification.permission !== status) {
        Notification.permission = status;
      }
    });
  }
});



cnt=0;
function notify(mesg,img,snd){
cnt++;
    // If the user agreed to get notified
    // Let's try to send ten notifications
    if (window.Notification && Notification.permission === "granted") {
      var i = 0;
      // Using an interval cause some browsers (including Firefox) are blocking notifications if there are too much in a certain time.
      var interval = window.setInterval(function () {
        // Thanks to the tag, we should only see the "Hi! 9" notification 
   if (i++ == 9) {      
  var n = new Notification(mesg,{tag: 'soManyNotification',image:img,sound:snd});
  playAudio(audiofile);
          //window.clearInterval(interval);
}      
}, 200);
    }

    // If the user hasn't told if he wants to be notified or not
    // Note: because of Chrome, we are not sure the permission property
    // is set, therefore it's unsafe to check for the "default" value.
    else if (window.Notification && Notification.permission !== "denied") {
      Notification.requestPermission(function (status) {
        // If the user said okay
        if (status === "granted") {
          var i = 0;
          // Using an interval cause some browsers (including Firefox) are blocking notifications if there are too much in a certain time.
          var interval = window.setInterval(function () {
            // Thanks to the tag, we should only see the "Hi! 9" notification 
              var n = new Notification(mesg, {tag: 'soManyNotification'});
            if (i++ == 9) {
              window.clearInterval(interval);
            }
          }, 200);
        }

        // Otherwise, we can fallback to a regular modal alert
        else {
          alert(mesg);
        }
      });

    }
    // If the user refuses to get notified
    else {
      // We can fallback to a regular modal alert
      alert(mesg);
    }
  };

   /******************************************************/
  /*   Utility Funktionen                               */
 /******************************************************/ 

       function variable_set(key, value) {
           console.log(value,key);
           setCookie(key,JSON.stringify(value));
           /*
            if (typeof (window.Storage) !== "undefined") {
                window.localStorage.setItem(key, JSON.stringify(value));
            } else {
                console.error('window.localStorage', 'ERROR');
            }
            */
        }

        function variable_get(key) {
            var ret=getCookie(key);
            return JSON.parse(ret);
            /*
            if(!def||def=='undefined')def=null;
            if (typeof (window.Storage) !== "undefined") {
                item = JSON.parse(window.localStorage.getItem(key));
                if (item == undefined) return def;
                return item;
            } else {
                console.error('window.localStorage', 'ERROR');
            }
            */
        }

        function variable_del(key) {
        setCookie(key,null,-1);
            /*
            $
            if (typeof (window.Storage) !== "undefined") {
                window.localStorage.removeItem(key);
            } else {
                console.error('window.localStorage', 'ERROR');
            }
            */
        }


 function setCookie(key, value, days) {
            var expires = new Date();
            if (days) {
                expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
            } else {
                document.cookie = key + '=' + value + ';expires=Fri, 30 Dec 9999 23:59:59 GMT;';
            }
        }

        function getCookie(key) {
            var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
            return keyValue ? keyValue[2] : null;
        }

function getFormattedDate(time) {
    var date = new Date(time);

    var year = date.getFullYear() 
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var min = date.getMinutes();
    var sec = date.getSeconds();

    month = (month < 10 ? "0" : "") + month;
    day = (day < 10 ? "0" : "") + day;
    hour = (hour < 10 ? "0" : "") + hour;
    min = (min < 10 ? "0" : "") + min;
    sec = (sec < 10 ? "0" : "") + sec;

    var today = new Date();
    var tyear = ''+today.getFullYear();
    var tmonth = today.getMonth() + 1;
    var tday = today.getDate();

    tmonth = (tmonth < 10 ? "0" : "") + tmonth;
    tday = (tday < 10 ? "0" : "") + tday;

    var str =  day + "."+ month + "."  +year + " " +  hour + ":" + min + ":" + sec;
    var rep = tday  +"."+tmonth+"."+tyear;

//    tyear=tyear.substring(2,4);
//    alert(tyear);
    if(tday+tmonth+tyear==day+month+year)str=str.replace(rep,''); 
    
    return str;
}

function convertLinks(txt){
   txt=txt.replace(/((http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png))/g,'<img  src="$1">')
   txt=txt.replace(/((http|https|ftp):\/\/[\w?=&.\/-;#~%-]+(?![\w\s?&.\/;#~%"=-]*>))/g, '<a href="$1" target="_BLANK">$1</a>');
   return txt;
}

function isAdmin(){
var user=variable_get('user');
if(user_has_role(user,'administrator'))return true;
else return false;
}

function isModerator(){
var user=variable_get('user');
if(user_has_role(user,'moderator'))return true;
else return false;
}

function isAnon(){
var user=variable_get('user');
if(!user_has_role(user,'anonymous user'))return false;
else return true;
}



function user_has_role(user,hasrole){
    let k=Object.keys(user._roles);
    let r=false;
    k.forEach(function(role){
        console.log(user._roles[role]+' = '+ hasrole);
        if(hasrole==user._roles[role])r=true;
    });
return r;
}

function l(name,url,options){
    if(!options||options=="undefined")options={};
    let link='<a href="'+url+'" ';
    let keys=Object.keys(options);
    keys.forEach(function(key) {
        var option=key+'="'+options[key]+'"';   
         link=link+' '+option;
    });
    link+='>'+name+'</a>'
return link;
}

function playAudio(audiofile) {
    let audio = new Audio(audiofile);
    audio.play();
} 

function isEmoji(str) {
    var ranges = [
        '\ud83c[\udf00-\udfff]', // U+1F300 to U+1F3FF
        '\ud83d[\udc00-\ude4f]', // U+1F400 to U+1F64F
        '\ud83d[\ude80-\udeff]' // U+1F680 to U+1F6FF
    ];
    if (str.match(ranges.join('|'))) {
        return true;
    } else {
        return false;
    }
}

  if (!String.prototype.startsWith) {
  String.prototype.startsWith = function(searchString, position) {
     position = position || 0;
    return this.indexOf(searchString, position) === position;
  };
}  


</script>

</body>
</html>
