<html lang="de">
<head>
<meta charset="utf-8"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="https://awri.ch/html/favicon.ico" type="image/vnd.microsoft.icon" />
<meta itemprop="image" content="https://awri.ch/sites/all/themes/awri_jqm/images/home_2.jpg" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1" /> 
<title>AWRI - Rechtsfrage Service</title>
<link rel="stylesheet" href="app/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" href="app/awri_chat.css" />

<script src=" //cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.slim.js"></script>
<!-- <script src="/socket.io/socket.io.js"></script> -->
<script src="app/jquery-1.11.1.min.js"></script>
<script	src="app/jquery.mobile-1.4.5.min.js"></script> 
<script src="app/chat_client.js"></script>
<style>
</style>

</head>

<body onload="">
  <div data-role="page" id="index">

        <div data-role="panel" id="myheader" data-display="overlay" data-position="right">
                <h3>Mitglieder Online</h3>
                <ul id="users"></ul>
                <br>
                <p style="float:left;"><a href="#" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back" data-rel="close">Schliessen</a></p>
        </div><!-- // Panel -->
            
        <div data-role="header" data-position="fixed">
                <a href="#" data-icon="back" data-rel="back" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Back</a>
                <h1 id="user">User</h1>
            <a href="#myheader" data-icon="user" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Menu</a>   
        </div> <!--// Header -->
        
        <div data-role="content" class="emojis, loader" style="float:left;">
            <ul id="messages"></ul> 
        </div> <!--// Content -->      

        <div data-role="footer" data-position="fixed">

                <input class="emojis" type="text" id="msg" value="">
        <fieldset class="ui-grid-a">
                <div class="ui-block-a">
                        <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
                        <button class="color" style="background-color:#333;" onclick=setColor(this);>&nbsp;</button>          
                        <button class="color" style=" background-color:#a70301;" onclick="setColor(this);">&nbsp;</button>
                        <button class="color" style="background-color:#0000aa;" onclick=setColor(this);>&nbsp;</button>          
                        <button class="color" style="background-color:#555555;" onclick="setColor(this);">&nbsp;</button>
        
                        <button class="emojis" onclick="putSmiley(this);">üòä</button>
                        <button class="emojis" onclick="putSmiley(this);">‚ù§Ô∏è</button>
                        <button class="emojis" onclick="putSmiley(this);">üòØ</button>
                        <button class="emojis" onclick="putSmiley(this);">üëå</button>
                        <button class="emojis" onclick="putSmiley(this);">ü§¶</button>
                        <button class="emojis" onclick="putSmiley(this);">üôè</button>                         
                        <button class="color" id="actualcolor" style="background-color:#333" onclick=setColor(this);>üñäÔ∏è</button>                             
                        </fieldset>         
                    </div>
            <div class="ui-block-b">
                    <div data-role="controlgroup" data-type="horizontal">
                        <label for="checkbox-mini-0" title="Browser Benachrichtigungen  f√ºr private Nachrichtigungen an oder aus schalten">‚òëÔ∏è </label>
                        <input type="checkbox" name="checkbox" id="checkbox-mini-0" class="custom" data-mini="true" />                  
                        <input title="Nachricht senden [Enter]" type='button' href="#" onclick="sendText();"  value="Senden"></button>  
                    </div>
            </div>
        </fieldset>
       
         </div>  <!--// Footer -->
    </div><!--// Page -->
    <div data-role="fieldcontain"> 
            <input type="text" id="uid" value="" disabled>   
            <input type="text" id="name" value="" disabled>
            <input type="text" id="private-name" disabled>
            <input type="text" id="private" disabled>
            <input type="hidden" id="token" value="token" disabled>          
    </div>
    
<script>
var notifications=false; //browser notifications
var private=false;      //private msg toggle
var color ='#333';
var audiofile='app/notification.mp3'; //notification Alarm
var chat=null;
//Hack f√ºr Openshift
if(location.hostname==='localhost')chat=new ChatClient();
else chat=new ChatClient('https:','nodejs-mongo-persistent-chatserver.7e14.starter-us-west-2.openshiftapps.com');


$(function() {

    $('#msg').focus();
    $("input[type='checkbox']:first").attr("checked",notifications).checkboxradio("refresh");
    
//Enter
$("#msg").keypress(function (e) {
    if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
        //document.getElementById('sendr').click();
        //if(private)sendPrivateMessage();
        //else 
        if($('#msg').val().startsWith('/'))parseCommand($('#msg').val().substr(1,$('#msg').val().length));
        else sendText();
        return false;
    } else {
        return true;
    }
});

}); //jQuery


(function(){
    cmdInfo();
})();

function cmdInfo(){
    help=[
    '<h2>Willkommen im AWRI Chat</h2>',
    'Dieser Chat ist mit der AWRI Datenbank verbunden.',
    'Falls sie noch nicht auf <a href="https://awri.ch/" target="_BLANK">AWRI</a> (Alles was Recht ist) angemeldet sind,',
    'k√∂nnen sie nur als anonymer Benutzer an unserer Diskussion teilnehmen.',
    'Als anonymer Teilnehmer k√∂nnen sie im Chat keine erweiterten Funktionen ausf√ºhren.',
    'Bei erneutem laden des Browsers, werdem immer die letzten 15 Chat Nachrichten angezeigt.',
    'Schreiben sie <strong>/help</strong> oder <strong>/hilfe</strong> ins Chat Fenster, um weitere Hilfe anzuzeigen.',
    'Viel Spass bei Diskutieren und bitte immer freundlich bleiben.',
];
help.forEach(line => {
    appendLine(line)
});
$('#msg').val('');
}

function cmdHelp(){
    help=[
    '<h2>Hilfe</h2>',
    'Chat Befehle beginnen mit einem Slash /[Befehl],',
    'Befehlsliste (Alle Benutzer)',
    '<strong>/info</strong> (zeigt Informationen √ºber den Chat)',
    '<strong>/help</strong> (zeigt diese Hilfe)',
    '<strong>/clear</strong> (leert das Chat Fenster)',
    '<strong>/whoami</strong> (zeigt ihre Benutzer Informationen)',
    '<strong>/beep</strong> (spielt den Benachrichtiguns Ton ab)',
    '<strong>/search [Suchwort] {AND|OR} [Suchwort] ...</strong> (sucht in der AWRI Datenbank nach Ergebnissen)',
    '<strong>/show [Beitrags-ID]</strong> (zeigt den Beitrag mit der [Beitrags-ID] an)', 
];
help.forEach(line => {
    appendLine(line);
});
$('#msg').val('');
}

function cmdWhoami(){
    let user=variable_get('user');
    var k=Object.keys(user._roles);
    roles=''
    k.forEach(role => {
        roles+=user._roles[role]+',';
    });
    out=[
        '<h2>'+user._name+'</h2>',
        'Id: '+user._uid,
        'Email: '+user._email,
        'Rollen: '+roles,
        'Link: https://awri.ch/user/'+user._uid,
        'Bild:'+ user._picture,
    ]
    out.forEach(line => {
       appendLine(line);
       $('#msg').val('');
    });
    console.log(user_has_role('administrator'),'ISADMIN?');
    console.log(user_has_role('authenticated user'),'ISUSER?');
    console.log(user_has_role('moderator'),'MODERATOR?');

}

function cmdClear(){
    $('#messages').html('');
    $('#msg').val('');
}

function cmdBeep(){
    playAudio(audiofile);
    $('#msg').val('');
}


function showLoader(){
    $.mobile.loading( 'show', {
	text: 'Lade, bitte warten...',
	textVisible: true,
	theme: 'b',
	html: ""
});
};

function hideLoader(){
    $.mobile.loading( 'hide');
};

function cmdSearch(text){
showLoader();
    searchNode(text).then(function(res){
    console.log(res);
        res.forEach(node => {
        appendLine('<a href="'+node.link+'" target="_BLANK"><strong>'+node.node.nid+'</strong></a> '+node.snippet);
        });
        hideLoader();
    }).catch(function(err){
        appendLine('Keine Ergebnisse f√ºr "'+text+'" gefunden!' ,'red');
        hideLoader();
    });
$('#msg').val('');
}

function cmdShow(nid){
    showLoader();   
    showNode(nid).then(function(node){   
    appendLine(theme_node(node));  
    showComments(nid).then(function(res){
                        appendLine(theme_comments(res));  
                        }).catch(function(err){
                            appendLine('Fehler: "'+err+'" !' ,'red');
                        }); 
    hideLoader();
}).catch(function(err){
    appendLine('Fehler: "'+err+'" !' ,'red');
    hideLoader();
});

$.mobile.loading( "hide" );
$('#msg').val('');
}

function cmdKick(uid){
var cmd=new ChatCommand('kick',{_from:variable_get('user')._uid,_to:uid}); 
chat.sendCommand(cmd);
}

function parseCommand(cmd){
    console.log(cmd,'parseCommand');
   if(cmd=='help'||cmd=='hilfe')cmdHelp();
   if(cmd=='info')cmdInfo();
   if(cmd=='clear')cmdClear();  
   if(cmd=='whoami')cmdWhoami();
   if(cmd=='beep')cmdBeep();
   if(cmd.startsWith('search'))cmdSearch(cmd.substr(7,cmd.length));
   if(cmd.startsWith('show'))cmdShow(cmd.substr(5,cmd.length));
   if(cmd.startsWith('kick'))cmdKick(cmd.substr(5,cmd.length));           
}

function onchatconnected(user){
    variable_set('user',user);
    $('#uid').val(user._uid);
    $('#name').val(user._name);
    $('#user').html('<img src="'+user._picture+'" width="20" height="20"/>'+user._name);
    appendLine(user._name+': connected','green');
}

function onchatmessage(msg){
    console.log(msg,'onchatmessage');
    if(notifications&&msg._to.uid==variable_get('user')._uid)notify(getFormattedDate(msg._time)+': '+msg._from.name+': '+msg._txt,msg._from.picture,audiofile);
    appendLine('<small>'+getFormattedDate(msg._time)+'</small>: <img src="'+msg._from.picture+'" width="20" height="20"/> '+msg._from.name+': '+msg._txt,msg._color);
}

function onchatuserlist(data){
    ul = document.getElementById('users');
        ul.innerHTML = "";
        data.forEach(user => {
        li = document.createElement('li');
        li.setAttribute('onclick', 'setPriv(this);');
        li.setAttribute('id', user.uid);
        if($('#private').val()==user.uid)li.classList.add("selected");
       if(user_has_role,'adminstrator')user.name='<span style="color:red;">üõ°Ô∏è</span>'+user.name;
       else if(user_has_role,'moderator')user.name='<span style="color:blue;">üõ°Ô∏è</span>'+user.name;
        li.setAttribute('name', user.name);
        //li.appendChild(document.createTextNode(user.uid + ' ' + user.name))
        li.innerHTML='<img src="'+user.picture+'" width="20" height="20"> ' + user.name;
        ul.appendChild(li);
        });
}

var private=false;
function setPriv(li){
    if($('#users .selected').attr('id')==li.id)return unsetPriv();
    var name=$('#users .selected').attr('name');

    $('#private').val(li.id);
    $('#private-name').val($(li).attr('name'));
    //alert(li.privatename);
    $('#users  li').removeClass('selected');
    //$('li[id='+li.id+']').addClass('selected');
    $(li).addClass('selected');
    $('#message').focus();  
    private=true;
};

function unsetPriv(){
    $('#private').val(-1);
    $('#private-name').val('');
    $('#users li').removeClass('selected');
    $('#message').focus();  
    private=false;
};

function onchatcommand(data){
    console.log(data,'onchatcommand');
}

function sendText(txt){
var msg=new ChatMessage();
msg.setColor(color);
msg.setFrom($('#uid').val());
msg.setText($('#msg').val());
if(private){
    msg.setColor('red');
    chat.sendPrivateMessage($('#private').val(),msg);
    appendLine('<small>'+getFormattedDate(msg._time)+'</small>: <img src="'+variable_get('user')._picture+'" width="20" height="20"> Du an '+$('#private-name').val()+': '+msg._txt,msg._color)
}
else chat.sendMessage(msg);

$('#msg').val("");
$('#msg').focus();
}

function sendPrivateText(to,txt){
msg=new ChatMessage();
//msg.setTo(document.getElementById('To'.value);
msg.setText(document.getElementById('sendPrivateMessage').value);
chat.sendPrivateMessage(document.getElementById('To').value,msg);
document.getElementById('sendPrivateMessage').value="";
document.getElementById('sendPrivateMessage').focus();
}



/*
var site="https://awri.ch";
var endpoint="drupalgap";
AWRI.setup(site,endpoint);

(async function(){
let res = await AWRI.token().catch(function(err){ alert(err); });

let res2 = await AWRI.connect().catch(function(err){ alert(err); });

//alert(res2.user.name);
console.log(res2.user.name);
chatuser =new ChatUser(res2.user.uid,res2.user.name); 
//user._fbid = user.field_fbid['und'][0].value;
chatuser._roles = res2.user.roles;
chatuser._session = res2.session_name+'_'+res2.sessid;
chatuser._token = res2.token;

let res3 = await AWRI.loadUser(chatuser._uid).catch(function(err){  alert(err); });
console.log(res3,"LOADUSER");
chatuser.uid=res3.uid;
chatuser._picture = res3.picture.url;
chatuser._email = res3.mail;

console.log(chatuser,"CHATUSER");
$('#name').val(chatuser._name);
$('#uid').val(chatuser._uid,chatuser);
let searc= await AWRI.search('Miete').catch(function(err){alert(err);});
console.log(searc,"SEARCH");

let node= await AWRI.loadNode(16435).catch(function(err){alert(err);});
console.log(node,"NODE");

let comments= await AWRI.loadComments(16435).catch(function(err){alert(err);});
console.log(comments,"ComemntsNODE");

chat.connect(chatuser)
})();

(function(){
    help.forEach(line => {
    console.log(line);
    $('#messages').append('<li>'+line+'</li>');
});
})();
*/
function setColor(c){
    var actualcol=$('#actualcolor');
    actualcol.attr('style','background-color:'+c.style['background-color']);
    color=c.style['background-color'];
}


function appendLine(text="",color="#333"){
    ul = document.getElementById('messages');
    li = document.createElement('li');
    li.style.color=color;
    li.innerHTML=text;
    ul.appendChild(li); 
    window.scrollTo(0, document.body.scrollHeight);   
}

function putSmiley(c){
    var smiley=($(c).text())
    var txt=$('#msg').val();
    $('#msg').val(txt+smiley);
}


function toggleComments(nid) {
    var x = document.getElementById("comments-"+nid);
    if (x.style.display === "none") {
        x.style.display = "block";
        $('#icon-'+nid).removeClass('ui-icon-plus');
        $('#icon-'+nid).addClass('ui-icon-minus');
    } else {
        x.style.display = "none";
        $('#icon-'+nid).removeClass('ui-icon-minus');
        $('#icon-'+nid).addClass('ui-icon-plus');
 
    }
}
    


   /******************************************************/
  /*   Notifications                                     */
 /******************************************************/ 

window.addEventListener('load', function () {
  // At first, let's check if we have permission for notification
  // If not, let's ask for it
  if (window.Notification && Notification.permission !== "granted") {
    Notification.requestPermission(function (status) {
      if (Notification.permission !== status) {
        Notification.permission = status;
      }
    });
  }
});


$("input[type='checkbox']").bind( "change", function(event, ui) {
notifications= $('input[type="checkbox"]').prop("checked");
});

cnt=0;
function notify(mesg,img,snd){
cnt++;
    // If the user agreed to get notified
    // Let's try to send ten notifications
    if (window.Notification && Notification.permission === "granted") {
      var i = 0;
      // Using an interval cause some browsers (including Firefox) are blocking notifications if there are too much in a certain time.
      var interval = window.setInterval(function () {
        // Thanks to the tag, we should only see the "Hi! 9" notification 
   if (i++ == 9) {      
  var n = new Notification(mesg,{tag: 'soManyNotification',image:img,sound:snd});
  playAudio(audiofile);
          //window.clearInterval(interval);
}      
}, 200);
    }

    // If the user hasn't told if he wants to be notified or not
    // Note: because of Chrome, we are not sure the permission property
    // is set, therefore it's unsafe to check for the "default" value.
    else if (window.Notification && Notification.permission !== "denied") {
      Notification.requestPermission(function (status) {
        // If the user said okay
        if (status === "granted") {
          var i = 0;
          // Using an interval cause some browsers (including Firefox) are blocking notifications if there are too much in a certain time.
          var interval = window.setInterval(function () {
            // Thanks to the tag, we should only see the "Hi! 9" notification 
              var n = new Notification(mesg, {tag: 'soManyNotification'});
            if (i++ == 9) {
              window.clearInterval(interval);
            }
          }, 200);
        }

        // Otherwise, we can fallback to a regular modal alert
        else {
          alert(mesg);
        }
      });

    }
    // If the user refuses to get notified
    else {
      // We can fallback to a regular modal alert
      alert(mesg);
    }
  };


   /******************************************************/
  /*   Utility Funktionen                               */
 /******************************************************/ 

       function variable_set(key, value) {
            if (typeof (window.Storage) !== "undefined") {
                window.localStorage.setItem(key, JSON.stringify(value));
            } else {
                console.error('window.localStorage', 'ERROR');
            }
        }

        function variable_get(key, def = null) {
            if (typeof (window.Storage) !== "undefined") {
                item = JSON.parse(window.localStorage.getItem(key));
                if (item == undefined) return def;
                return item;
            } else {
                console.error('window.localStorage', 'ERROR');
            }
        }

function getFormattedDate(time) {
    var date = new Date(time);

    var year = date.getFullYear() 
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var min = date.getMinutes();
    var sec = date.getSeconds();

    month = (month < 10 ? "0" : "") + month;
    day = (day < 10 ? "0" : "") + day;
    hour = (hour < 10 ? "0" : "") + hour;
    min = (min < 10 ? "0" : "") + min;
    sec = (sec < 10 ? "0" : "") + sec;

    var today = new Date();
    var tyear = ''+today.getFullYear();
    var tmonth = today.getMonth() + 1;
    var tday = today.getDate();

    tmonth = (tmonth < 10 ? "0" : "") + tmonth;
    tday = (tday < 10 ? "0" : "") + tday;

    var str =  day + "."+ month + "."  +year + " " +  hour + ":" + min + ":" + sec;
    var rep = tday  +"."+tmonth+"."+tyear;

//    tyear=tyear.substring(2,4);
//    alert(tyear);
    if(tday+tmonth+tyear==day+month+year)str=str.replace(rep,''); 
    
    return str;
}

function readCookie(){
    uid=read_cookie('DRUPAL_UID');
    name=read_cookie('sessname');
    id=read_cookie('sessid');
    token=read_cookie('token');
    document.getElementById('uid').value=uid;
    document.getElementById('sessname').value=name;
    document.getElementById('sessid').value=id;
    document.getElementById('token').value=token;
}     

function read_cookie(key)
{
    var result;
    return (result = new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)').exec(document.cookie)) ? (result[1]) : null;
}

function user_has_role(user,hasrole){
    var k=Object.keys(user._roles);
    let r=false;
    k.forEach(role => {
        if(hasrole==user._roles[role])r=true;
    });
return r;
}

function playAudio(audiofile) {
    var audio = new Audio(audiofile);
    audio.play();
} 

         function theme_node(node){
            var n='<h1>'+node.nid+'</h1>';
            n+='<h2>'+theme_fb_image(node.field_fbid['und'][0].value)+node.field_fbname['und'][0].value+'</h2>';
            n+='<p>'+node.body['und'][0].safe_value+'</p>';
          //  n+='<div id="comments"></div>';
            return n;
        }
        
        function theme_fb_image(fbid){
            return '<img src="https://graph.facebook.com/'+fbid+'/picture?type=small"/>';
        }

        function theme_comments(comments){
            if(comments.length<1)return;
            console.log(comments,"Comemnts");
//        var c='<button id="comment-btn-'+comments[0].nid+'" onclick="toggleComments('+comments[0].nid+');">+</button><div style="display:none;" id="comments-'+comments[0].nid+'">'
            var c='<a id="icon-'+comments[0].nid+'" onclick="toggleComments('+comments[0].nid+')" href="#" class="ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a><div style="display:none;" id="comments-'+comments[0].nid+'">'
            comments.forEach(comment => {
                console.log(comment,"c");
                c+='<span><strong>'+comment.subject+'</strong>'
                c+=''+comment.comment_body['und'][0].safe_value+'</span>'

            });
        c+="</div>";
        return c;
        }

          /******************************************************/
  /*   AWRI Connect                                     */
 /******************************************************/ 


        var host = 'https://awri.ch';
        var endpoint = 'drupalgap';

    function token() {
        return new Promise(function (resolve, reject) {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.withCredentials = true;
            xmlhttp.open("GET", "https://awri.ch/services/session/token", true);
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.status == 200 && xmlhttp.readyState == 4) {
                    var token = xmlhttp.responseText;
                    variable_set('token', token);
                    return resolve(token);
                }
                if (xmlhttp.status != 200) rej(xmlhttp.status);
            };
            xmlhttp.send();
        });
    };            

        function connect(token) {
            return new Promise(function (resolve, reject) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.withCredentials = true;
                xmlhttp.crossDomain = true;
                xmlhttp.open("POST", host + "/" + endpoint + "/system/connect.json", true);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                xmlhttp.setRequestHeader("X-CSRF-Token", token);
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.status == 200 && xmlhttp.readyState == 4) {
                        var response = xmlhttp.responseText;
                        obj = JSON.parse(response);                        
                        user._uid=obj.user.uid;
                        user._session=obj.session_name + '_' + obj.sessid;
                        user._token=token;
                        user._roles = user.roles;
                        if(obj.user.name)user._name=obj.user.name;
                        variable_set('user', user);
                        variable_set('session', obj.session_name + '_' + obj.sessid);
                        resolve(variable_get('user'));
                    }
                    if (xmlhttp.status != 200) reject(xmlhttp.status);
                };
                xmlhttp.send();
            });
        }


        function loaduser(uid) {
            return new Promise(function (resolve, reject) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.withCredentials = true;
                xmlhttp.crossDomain = true;
                xmlhttp.open("GET", host + "/" + endpoint + "/user/" + uid + ".json", true);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                xmlhttp.setRequestHeader("X-CSRF-Token", variable_get('token'));
                //xmlhttp.setRequestHeader("Cookie",variable_get('session'));
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.status == 200 && xmlhttp.readyState == 4) {
                        var user = JSON.parse(xmlhttp.responseText);                
                        user._uid = user.uid;
                        user._name = user.name;
                        user._fbid = user.field_fbid['und'][0].value;
                        user._picture = user.picture.url;
                        user._email = user.mail;
                        user._roles = user.roles; 
                        user._session =variable_get('session');
                        user._token =variable_get('token');
                                           
                      
                    
                        variable_set('user', user);
                        return resolve(user);
                    }
                    if (xmlhttp.status != 200) reject(xmlhttp.status);
                };
                xmlhttp.send();
            });
        }

        (function main(){
        token().then(function (token) {           
            connect(token).then(function (user) {
//                console.log(user, 'connect');
                if (user._uid !== 0)
                    loaduser(user._uid).then(function (user) {
                        variable_set('user', user);
                        //   variable_set('session',user.session_name+'_'+user.sessid);
  //                      console.log(user, 'loaduser');
                        chat.connect( variable_get('user'));
                    }).catch(function (err) { console.error(err, 'loaduser') })
                else chat.connect(user);

            }).catch(function (err) { console.error(err, 'connect') });
        }).catch(function (err) { console.error(err, 'token') })
    })();
   

     function searchNode(txt) {
            return new Promise(function (resolve, reject) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.withCredentials = true;
                xmlhttp.crossDomain = true;
                xmlhttp.open("GET", host + "/" + endpoint + "/search_node/retrieve.json?keys="+txt, true);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                xmlhttp.setRequestHeader("X-CSRF-Token", variable_get('token'));
                //xmlhttp.setRequestHeader("Cookie",variable_get('session'));
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.status == 200 && xmlhttp.readyState == 4) {
                        var result= JSON.parse(xmlhttp.responseText);                                                           
                        return resolve(result);
                    }
                    if (xmlhttp.status != 200) reject(xmlhttp.status);
                };
                xmlhttp.send();
            });
        }

  
  
  function showNode(nid) {
            return new Promise(function (resolve, reject) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.withCredentials = true;
                xmlhttp.crossDomain = true;
                xmlhttp.open("GET", host + "/" + endpoint + "/node/"+nid+".json", true);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                xmlhttp.setRequestHeader("X-CSRF-Token", variable_get('token'));
                //xmlhttp.setRequestHeader("Cookie",variable_get('session'));
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.status == 200 && xmlhttp.readyState == 4) {
                        var result= JSON.parse(xmlhttp.responseText);                                              
                        return resolve(result);
                    }
                    if (xmlhttp.status != 200) reject(xmlhttp.status);
                };
                xmlhttp.send();
            });
        }

        
  function showComments(nid) {
            return new Promise(function (resolve, reject) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.withCredentials = true;
                xmlhttp.crossDomain = true;
                xmlhttp.open("GET", host + "/" + endpoint + "/comment.json?parameters[nid]="+nid+"&parameters[status]=1&pagesize=150", true);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                xmlhttp.setRequestHeader("X-CSRF-Token", variable_get('token'));
                //xmlhttp.setRequestHeader("Cookie",variable_get('session'));
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.status == 200 && xmlhttp.readyState == 4) {
                        var result= JSON.parse(xmlhttp.responseText);                                                                    
                        return resolve(result);
                    }
                    if (xmlhttp.status != 200) reject(xmlhttp.status);
                };
                xmlhttp.send();
            });
        }

</script>

</body>
</html>
